<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/ScrollMagic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/plugins/animation.gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/plugins/animation.velocity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/plugins/debug.addIndicators.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/plugins/jquery.ScrollMagic.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: black;
            height: 100%;
            overflow: hidden;
        }
        .progress {
            position: absolute;
            top: 50%;
            left: 30%;
            transform: translate(0%, -50%);
            width: 40%;
            margin-top: auto;
            margin-bottom: auto;
        }
        .container {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            padding-left: 0;
            padding-right: 0;
            display: flex;
        }
        .model {
            max-width: 100%;
            max-height: 100%;
            opacity:0;
        }
    </style>
</head>

<body>
    <div class="progress">
        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="1750">
            <span class="sr-only">70% Complete</span>
        </div>
    </div>
</body>
<script>
    $(function () {
        let model_list = [
            'utopian01',
            'utopian02',
            'reflective01',
            'reflective02',
            'reflective03'
        ];
        let progress = 0;
        let images = new Array(model_list.length);
        const img_n = 250,
            per_enter_duration = document.documentElement.clientHeight * 0.5,
            per_center_duration = document.documentElement.clientHeight,
            per_leave_duration = document.documentElement.clientHeight * 0.5;

        /*
         * Image Loading
         */
        for (var j = 0; j < model_list.length; j++) {
            images[j] = new Array();
            // Create scene
            document.body.innerHTML +=
                `<div id="scene${j+1}" class="container" style="visibility:hidden"><img id="model${j+1}" class="model mx-auto my-auto"></div>`;

            for (var i = 0; i < img_n; i++) {
                var img_temp = new Image();
                img_temp.addEventListener('load', () => {
                    progress += 1;
                    // Update progress bar
                    if (progress % img_n == 0) {
                        $('.progress-bar').css('width', progress / (model_list.length * img_n) * 100 +
                            '%').attr("aria-valuenow", progress);
                    }
                    // End of loading
                    if (progress == img_n * model_list.length) {
                        document.body.style.overflow = 'visible';
                        $('.container').css('visibility', 'visible');
                        $('.progress').css('display', 'none');
                        ImageLoadedEnd();
                    }
                });
                img_temp.src = `./assets/${model_list[j]}/${model_list[j]}${i.toString().padStart(3,'0')}.jpg`;
                images[j].push(img_temp);
            }
        }

        function ImageLoadedEnd() {
        /*
         * Scroll Animation
         */

        // init controller
        let controller = new ScrollMagic.Controller({
            globalSceneOptions: {
                triggerHook: 0
            }
        });

        // TweenMax can tween any property of any object. We use this object to cycle through the array
        let currs = new Array(model_list.length);

        for (var i = 0; i < model_list.length; i++) {
            currs[i] = {
                cur_img: 0
            };

            // create tween
            var enter_tween = TweenMax.to(`#model${i+1}`, 1, {opacity:1});

            var center_tween = TweenMax.to(currs[i], 1 / model_list.length, {
                cur_img: img_n - 1,
                roundProps: "cur_img",
                repeat: 0,
                immediateRender: true,
                ease: Linear.easeNone, // show every image the same ammount of time
                onUpdate: function (model_name) {
                    $(`#model${model_name+1}`).attr("src", images[model_name][currs[model_name]
                        .cur_img
                    ].src);
                },
                onUpdateParams: [i]
            });

            var leave_tween = TweenMax.to(`#model${i+1}`, 1, {opacity:0});

            // enter scene
            var enter_scene = new ScrollMagic.Scene({
                    triggerElement: `#scene${i+1}`,
                    triggerHook: "onEnter",
                    offset: -per_enter_duration,
                    duration: per_enter_duration,
                })
                .setTween(enter_tween)
                .addIndicators({name: `enter model ${i+1}`})
                .addTo(controller);

            // center scene
            var center_scene = new ScrollMagic.Scene({
                    triggerElement: `#scene${i+1}`,
                    duration: per_center_duration,
                })
                .setPin(`#scene${i+1}`)
                .setTween(center_tween)
                .addIndicators({name: `center model ${i+1}`})
                .addTo(controller);
            
            // leave scene
            var leave_scene = new ScrollMagic.Scene({
                    triggerElement: `#scene${i+1}`,
                    triggerHook: "onLeave",
                    offset: per_center_duration,
                    duration: per_leave_duration,
                })
                .setTween(leave_tween)
                .addIndicators({name: `leave model ${i+1}`})
                .addTo(controller);
        }

        }
    });
</script>

</html>